pico-8 cartridge // http://www.pico-8.com
version 42
__lua__
function _init()
	-- target point
	p={
		x=64,y=0,dx=0,dy=0
	}
	-- missiles
	mssl={}
	-- explosion
	explosion={}
	-- global counter/frame
	gcnt=0
end

function _update60()
	-- + frame count
	gcnt+=1
	-- target point control
	local spdm=2 -- max speed
	if btn(⬆️) then
		p.dy=max(p.dy-0.2,-spdm)
	elseif btn(⬇️) then
		p.dy=min(p.dy+0.2,spdm)
	elseif btn(➡️) then
		p.dx=min(p.dx+0.2,spdm)
	elseif btn(⬅️) then
		p.dx=max(p.dx-0.2,-spdm)
	end
	p.x=mid(0,p.x+p.dx,127)
	p.y=mid(0,p.y+p.dy,127)
	
	-- generate missile
	if gcnt%2==0 then
		local m={
			x=0, y=127,
			dx=0, dy=0,
			r=0,
			cnt=0,
			len=100,
			type=rnd{1,2,3},
			spd=1+rnd{1,1.5,2},
			path={}
		}
		m.int={
			x=m.x+rnd(200)-100,
			y=m.y+rnd(200)-100
		}
		add(m.path,{x=m.x,y=m.y})
		local v=calc_v(m.int.x,m.int.y,p.x,p.y,m.spd)
		m.dx,m.dy=v[1],v[2]
		m.r=atan2(m.dx,m.dy)
		add(mssl,m)
	end

	-- all missiles
	for m in all(mssl) do
		-- inside counter
		m.cnt+=1
		-- living
		if m.len>15 and m.cnt<100 then
			-- generate missles per 10 frames.
			if m.cnt%10==0 then
				local alpha,v=({0.1,0.3,0.5})[m.type]
				if m.cnt<30 then
					-- go to the dummy target
					v=calc_v(m.int.x,m.int.y,p.x,p.y,m.spd)
				else
					-- go to the target
					v=calc_v(m.x,m.y,p.x,p.y,m.spd)
				end
				-- get directions and the distance to the target
				m.dx=m.dx*(1-alpha) + v[1]*alpha
				m.dy=m.dy*(1-alpha) + v[2]*alpha
				m.len=v[3]
				add(m.path,{x=m.x, y=m.y})
				-- remove the oldest smoke point
				if #m.path>10 then
					deli(m.path,1)
				end
				-- missile direction
				m.r=atan2(m.dx,m.dy)
			end
			m.x+=m.dx
			m.y+=m.dy
		else
		-- explision
			add(explosion,{
				x=m.x,
				y=m.y,
				r=0
			})
			delmssl(m)
		end
		-- remove the missile when go out of screen
		if screenout(m.x+m.dx,m.y+m.dy) then
			delmssl(m)
		end
	end
	-- all explosions
	for e in all(explosion) do
		e.r+=0.5
		if e.r>4 do
			del(explosion,e)
		end
	end
end

function _draw()
	cls()
	for m in all(mssl) do
		for idx=1,#m.path do
			p1,p2=
			m.path[idx],m.path[idx+1]
			if p2==nil then p2={x=m.x,y=m.y} end
			line(p1.x,p1.y,p2.x,p2.y,({1,1,5,5,13,13,6,6,7,7})[idx])
		end
		rotate(m.x+m.dx,m.y+m.dy,m.r,0,0,1,1,1)
	end
	for e in all(explosion) do
		circfill(e.x,e.y,e.r,({7,9,8})[ceil(e.r)])
	end
	pset(p.x,p.y,8)
	print("missiles:"..#mssl)
end


-->8
-- rotate a sprite
function rotate(x,y,rot,mx,my,w,flip,scale)
	scale=scale or 1
	w+=.8
	local halfw,cx=
		scale*-w/2,
		mx+w/2 -.4
	local cs,ss,cy=
		cos(rot)/scale, -sin(rot)/scale,
		my-halfw/scale-.4
	local sx,sy,hx,hy=
		cx+cs*halfw, cy-ss*halfw,
		w*(flip and -4 or 4)*scale,
		w*4*scale

	for py=y-hy,y+hy do
		tline(
			x-hx,py, x+hx,py,
			sx+ss*halfw, sy+cs*halfw,
			cs/8,-ss/8
		)
		halfw+=1/8
	end
end
-- screen out
function screenout(x,y)
	if (x<0 or x>127)
	or (y<0 or y>127) then
		return true
	else
		return false
	end
end
-- calcurate directions and the distance
function calc_v(px, py, tx, ty, speed)
	local dx,dy=tx-px,  ty-py
	local length=sqrt(dx^2 + dy^2)
	local vx,vy=(dx/length)*speed, (dy/length)*speed
	return {vx, vy, length}
end
-- delete element
function delmssl(m)
	if m.cnt%2==0 then
		del(m.path,m.path[1])
	end
	if #m.path<=0 then
		del(mssl,m)
	end
end
__gfx__
0000000000000000aaaaaaaa88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000a555559a82555558000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070000000000a555599a82255558000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0007700000066669a555999a82225558000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00077000000dddd4a559999a82222558000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0070070000000000a599998a8e222258000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000a999988a8ee22228000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000aaaaaaaa88888888000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000cccccccc22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000cbbbb33c2ee88882000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000c5bbbb3c2e888852000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000c55bbbbc28888552000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000c555bbbc28885552000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000c5555bbc28855552000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000c55555bc28555552000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000cccccccc22222222000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__label__
88808880088008808880800088800880000088008880000000000000000000000000000000000000000000000000000000000000000000000000000000000000
88800800800080000800800080008000080008000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000
808008008880888008008000880088800000080ddd8dd00000000000000000000000000000000000000000000000000000000000000000000000000000000000
80800800008000800800800080000080080008d000800dddddddddddd00000000000000000000000000000000000000000000000000000000000000000000000
80808880880088008880888088808800000d888000800000000000000ddddd600000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000d000000000000000000000000000066000000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000000000dd00055dd000000000000000000000000660000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000d555550000dddd0dddd000888000000000006000000000000000000000000000000000000000000000000000000000000
00000000000000000000000000055dd5000000000000ddddd0d08999800000000000660000000000000000000000000000000000000000000000000000000000
000000000000000000000000555dd0000000000000dd00000d089979980000000000006000000000000000000000000000000000000000000000000000000000
00000000000000000000000500d000000000000ddd00000000089777980dddd00000000660000000000000000000000000000000000000000000000000000000
000000000000000000000050dd00000000000dd000000000000899799800000dddd0000006600000000000000000000000000000000000000000000000000000
00000000000000000000005d00000000000dd00000000000d660899980660000000dd60000060000000000000000000000000000000000000000000000000000
000000000000000000000dd0000000000dd00000000000dd0000088800dd00000000006600006600000000000000000000000000000000000000000000000000
0000000000000000000dd000000000ddd0000000000ddd0000000000000000000000000060000060000000000000000000000000000000000000000000000000
000000000000000000d500000000dd00000000000dd0000000000000000000000000000006600006600000000000000000000000000000000000000000000000
00000000000000000505000000dd00000000000dd000000000000000000000000000000000060000066000000000000000000000000000000000000000000000
000000000000000005500000dd0000000000ddd00000000000000000006660000000000000006600000600000000000000000000000000000000000000000000
0000000000000000550000050000000000dd0000000000000000000096ddd0000000000000000060000060000000000000000000000000000000000000000000
00000000000000005000000500000000dd0000000000000000000dddd40000000000000000000006600006000000000000000000000000000000000000000000
0000000000000005500000500000000d00000000000000000dddd000000000000000000000000000060006000000000000000000000000000000000000000000
000000000000000500000050000000d000000000000000ddd0000000000000000000000000000000006600600000000000000000000000000000000000000000
00000000000000500000050000000d000000000000dddd0000000000000000000000000000000000000060060000000000000000000000000000000000000000
0000000000000050000050000000d00000000000dd00000000000000000000000000000000000000000006606000000000000000000000000000000000000000
000000000000051000005000000d00000000000d0000000000000000000000000000000000000000000000060600000000000000000000000000000000000000
00000000000005100005000000d00000000000d00000000000000000000000000000000000000000000000006960000000000000000000000000000000000000
0000000000005100005000000d0000000000dd000000000000000000000000000000000000000000000000000dd6000000000000000888000000000000000000
0000000000005100005000000d000000000d000000000000000000000000000000000000000000000000000000dd660000000000008999800000000000000000
000000000005010005000000d000000000d00000000000000000000000000000000dddddddd0000000000000000dd60000000000089979980000000000000000
00000000000501000500000d000000000d000000000000000000000dddddddddddd00000000dd000000000000000d60000000000089777980000000000000000
0000000000500100500000d000000000d0000000000000000dddddd0000000000066660000000dd00000000000000d0000000000089979980000000000000000
000000000050010500000d000000000d0000000000000005500000000000000009dddd000000000dd00000000000000000000000008999800000000000000000
00000000050010050000d000000000d0000000000000005000000000000000dddd400000000000000dd090000000000000000000000888000000000000000000
0000000005001050000d00000000dd0000000000000005000000000000dddd000000000000000000000446600000000000000000000000000000000000000000
000000005000150000d00000000d0000000000000005500000000000dd000000000000000000000000000dd66000000000000000000001000000000000000000
00000000500015000050000000d000000000000000500000000000050000000000000000000000000000000d0000000000000000000001000000000000000000
0000000500005000050000000d0000000000000005000000000005500ddddddddddddddddddddddd966660000000000000000000000001000000000000000000
000000050000500005000000500000000000000550000000000050055000000000000000000000004dddd0000000000000000000000001000000000000000000
00000050000500005000000050000000000000500000000000050550000000000000000000000000000000000000000000000000000000100888000000000000
00000050005100005000000500000000000055000000000000555000000000000000000000000000000000000000000000000000000000108999800000000000
00000500005100050000000500000000000500000000000055500000000000000000000000000000000000000000000000000000000000089979980000000000
00000500050100050000005000000000005000000000000555000000000000000000000000000000000000000000000000000000000000089777980000000000
000005000500105000000050000000005500000000000055000000006dd000000000000000000000000000000000000000000000000000089979980000000000
000005000500105000000500000000050000000000005500000000066d0000000000000000000000000000000000000000000000000000108999800000000000
00005000500015000000050000000050000000000055500000000096d00000000000000000000000000000000000000000000000000001000888000000000000
00005000500015000000500000005500000000000550000000000094000000000000000000000000000000000000000000000000000001000000000000000000
00005000500051000000500000050000000000055500000000000500000000000000000000000000000000000000000000000000000001000000000000000000
00005000500051000005000000500000000005505000000000005000000000000000000000000000000000000000000000000000000001000000000000000000
00005005000501000050000000500000000550550000000000050000000000000000000000000000000000000000000000000000000001000000000000000000
00005005000501000050000005000000005005000000000000050000000000000000000000000000000000000000000000000000000001000000000000000000
00050005005000100500000005000000050050000000000000500000000000000000000000000000000000000000000000000000000010000000000000000000
00050005005000100500000050000000050500000000000005000000000000000000000000000000000000000000000000000000000010000000000000000000
00050050050000105000000050000000500500000000000050000000000000000000000000000000000000000000000000000000000010000000000000000000
00050050050000015000000500000005005000000000000500000000000000000000000000000000000000000000000000000000000010000000000000000000
00050050500000050000000500000050050000000000005000000000000000000000000000000000000000000000000000000000000000000000000000000000
00050050500000050000005000000050050000000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000
00500500500000510000050000000500500000000000050000000000000000000000000000000000000000000000000000000000000000000000000000000000
0050050050000050100005000000500500006dd00000500000000000000000000000000000000000000000000000000000000000000000000000000000000000
0050050500000500100050000005000500006d000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000
005005050000050000005000000500500006d0000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000
005050050000050000050000005005000094d0000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00505005000005000005000005000500000500000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05005005000050000050000050005000005000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05005050000050000500000050050000050000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05050050000050000500000500050000050000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05050050000500005000005000500000500000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05050050000500005000050005000005000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
05050050000500050000050005000005000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
50500500000500050000500050000050000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
50500500005000500005000500000500000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
50500500005000500050000500005000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10100500005005000050005000005000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10105000050001000500050000050000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10105000050010000100050000500000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10105000050010001000500000500000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10105000500010001000100005000005000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10105000500010001001000050000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10150000500100010001000050000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11050000500100010010000500000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11050005000100010010000500001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1101000500010010001000500000100000006dd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1101000100100010010000500001000000066d000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
110100010010010001000500001000000096d0000000000000000000000000000000000000000000000000000000000000000000000000008000000000000000
11010010001001001000050000100000009400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11010010010001001000500001000000005000000000006000000000000000000000000000000000000000000000000000000000000000000000000000000000
11010010010010001000500001000000050000000000066000000000000000000000000000000000000000000000000000000000000000000000000000000000
111000100100100100050000100000005000000000066dd000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100010010010010005000100000005000000000009d00000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100100100100100050000100000050000000000554000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100100100100100050001000000050000000055000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100100100101000500010000000500000000500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100101001001000500010000005000000055000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100101001001005000100000050000005500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10101001001010001001000000500000050000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10101001010010010001000005000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10101010010100010010000050000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10101010100100100100000500000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10110010100100100100001000000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11010010101001001000010000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11010101001001001000010000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11010101010010010000100000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11010101010010100001000011000006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100110010100100010000100000066000000600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
111010101001010001000010000006dd000006600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11101010101010000100010000009dd000066dd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
111010101010100010001000001140000004d0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11101101010100010001000001000000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11101101010100100010000010000001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11101101101001000100001100000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11110110101010001000010000011000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11011011010010010000100001100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11011011010100100011000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11011110101001000100001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11011110110010001000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11110101010100110001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111101100101000110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111111001010001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111101010109666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111110101004dddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111101010111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111110101110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111119666600000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111104dddd00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111011100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
11100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
10000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000

__map__
0100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000002030000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000012130000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000200003d6103d6203b6203863036630316302c64026640206401b640156400a6300060000600006000060000600006000060000600006000060000600006000060000600006000060000600006000060000600
